<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Transfer</title>
    <!-- The QR Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* Classic Dark UI */
        body { background-color: #121212; color: #00FF41; font-family: monospace; padding: 20px; }
        
        #drop-zone {
            border: 2px dashed #00FF41;
            padding: 50px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            opacity: 0.8;
        }
        #drop-zone:hover { opacity: 1; background: #1a1a1a; }

        .file-row {
            border: 1px solid #333;
            background: #1e1e1e;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 20px;
        }

        .info-col { flex-grow: 1; }
        .qr-col { width: 100px; height: 100px; background: white; padding: 5px; display: none; }

        h4 { margin: 0 0 5px 0; color: white; }
        
        /* The Progress Bar */
        .progress-container {
            width: 100%;
            height: 20px;
            background: #333;
            margin-top: 5px;
        }
        .bar {
            height: 100%;
            width: 0%;
            transition: width 0.2s;
        }
        /* Sending Color */
        .sending { background-color: #00FF41; } 
        /* Loading Color (preparing download) */
        .loading { background-color: #00d2ff; } 

        .status { margin-top: 5px; font-size: 12px; color: #888; }
        
        /* Download Button */
        .dl-btn {
            display: none;
            margin-top: 10px;
            background: #00FF41;
            color: black;
            text-decoration: none;
            padding: 5px 10px;
            font-weight: bold;
            display: inline-block;
        }
    </style>
</head>
<body>

    <div id="drop-zone">
        [ DRAG FILES HERE ]
        <input type="file" id="fileInput" multiple style="display:none">
    </div>

    <div id="list"></div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('fileInput');
        const list = document.getElementById('list');

        // --- Drag & Drop Setup ---
        dropZone.onclick = () => fileInput.click();
        
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.background = '#222'; };
        dropZone.ondragleave = () => { dropZone.style.background = 'transparent'; };
        
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.style.background = 'transparent';
            handleFiles(e.dataTransfer.files);
        };

        fileInput.onchange = (e) => handleFiles(e.target.files);

        function handleFiles(files) {
            Array.from(files).forEach(processFile);
        }

        function processFile(file) {
            // 1. Create UI immediately
            const row = document.createElement('div');
            row.className = 'file-row';
            row.innerHTML = `
                <div class="info-col">
                    <h4>${file.name}</h4>
                    <div class="progress-container">
                        <div class="bar sending" style="width:0%"></div>
                    </div>
                    <div class="status">Waiting to send...</div>
                    <a href="#" class="dl-btn" style="display:none">DOWNLOAD READY</a>
                </div>
                <div class="qr-col"></div>
            `;
            list.appendChild(row);

            const bar = row.querySelector('.bar');
            const status = row.querySelector('.status');
            const qrBox = row.querySelector('.qr-col');
            const dlBtn = row.querySelector('.dl-btn');

            // 2. PHASE 1: UPLOAD (Sending)
            const xhr = new XMLHttpRequest();
            const formData = new FormData();
            formData.append('file', file);

            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    bar.style.width = percent + '%';
                    status.innerText = `>> SENDING: ${Math.round(percent)}%`;
                }
            };

            xhr.onload = () => {
                if (xhr.status === 200) {
                    // Upload Done.
                    const fileUrl = xhr.responseText.trim(); // Server must echo the URL
                    
                    // Generate QR
                    qrBox.style.display = 'block';
                    new QRCode(qrBox, { text: fileUrl, width: 100, height: 100 });

                    // Switch Bar Color for Phase 2
                    bar.className = 'bar loading'; 
                    bar.style.width = '0%';
                    
                    // 3. PHASE 2: LOAD (Download Prep)
                    startLoading(fileUrl, bar, status, dlBtn, file.name);

                } else {
                    status.innerText = "Error: Server rejected file (Check upload_max_filesize)";
                    status.style.color = "red";
                    bar.style.background = "red";
                }
            };

            xhr.onerror = () => { status.innerText = "Network Error during Upload"; };

            // CHANGE THIS to your PHP/Node script
            xhr.open('POST', 'upload_script.php', true);
            xhr.send(formData);
        }

        function startLoading(url, bar, status, dlBtn, filename) {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.responseType = 'blob'; // Critical for "Loading" progress

            xhr.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    bar.style.width = percent + '%';
                    status.innerText = `<< LOADING: ${Math.round(percent)}%`;
                }
            };

            xhr.onload = function() {
                if (this.status === 200) {
                    // Finished
                    bar.style.width = '100%';
                    bar.style.background = '#00FF41'; // Green again
                    status.innerText = "Ready.";
                    
                    const blobUrl = window.URL.createObjectURL(this.response);
                    dlBtn.href = blobUrl;
                    dlBtn.download = filename;
                    dlBtn.style.display = 'inline-block';
                }
            };

            xhr.send();
        }
    </script>
</body>
</html>
