<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drop & Share</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f0f0f0; }
        
        /* Layout */
        #drop-zone {
            border: 3px dashed #007bff; border-radius: 10px; padding: 40px;
            margin: 20px auto; width: 85%; max-width: 500px; background: white;
            color: #555; transition: background 0.3s;
        }
        #drop-zone.highlight { background: #e0f0ff; }
        
        #status { margin: 10px 0; font-weight: bold; color: #333; }
        #qrcode { margin: 20px auto; display: flex; justify-content: center; }
        
        /* Controls */
        #controls { max-width: 500px; margin: 10px auto; display: none; justify-content: space-between; align-items: center; }
        button { padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button#download-all-btn { background: #28a745; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        /* File List */
        #file-list { list-style: none; padding: 0; max-width: 500px; margin: 0 auto; text-align: left; }
        .file-item {
            background: #fff; border: 1px solid #ddd; padding: 10px; margin-bottom: 8px;
            border-radius: 5px; transition: opacity 0.3s;
            display: flex; flex-direction: column; gap: 5px;
        }
        
        .file-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .file-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .file-meta { font-size: 0.8em; color: #666; }

        /* Progress Bar */
        .progress-bar-container { width: 100%; height: 6px; background: #eee; border-radius: 3px; overflow: hidden; margin-top: 5px;}
        .progress-bar-fill { height: 100%; background: #007bff; width: 0%; transition: width 0.1s linear; }

        /* Download UI (Hidden until done) */
        .download-ui { display: none; align-items: center; gap: 10px; }
        
        /* Sync Status (Grayed Out) */
        .file-item.downloaded { background: #f0f0f0; border-color: #eee; }
        .file-item.downloaded .file-name { color: #999; }
        .file-item.downloaded button { background: #ccc; pointer-events: none; }
        
        input[type="checkbox"] { transform: scale(1.2); cursor: pointer; }
    </style>
</head>
<body>

    <h1>File Loader</h1>
    <div id="status">Connecting to server...</div>

    <div id="qrcode"></div>
    <div id="link-container" style="display:none; margin-bottom: 15px;">
        <p>Scan to connect: <a id="join-link" href="#">Link</a></p>
    </div>

    <div id="drop-zone">
        Drag & Drop files here<br>
        <span style="font-size: 0.8em; color: #888;">(Or tap to select)</span>
        <input type="file" id="file-input" style="display: none;" multiple>
    </div>

    <div id="controls">
        <label style="display: flex; align-items: center; gap: 5px;">
            <input type="checkbox" id="select-all"> Select All
        </label>
        <button id="download-all-btn">Download Selected</button>
    </div>

    <ul id="file-list"></ul>

    <script>
        const peer = new Peer();
        let conn = null;
        
        // Storage for incoming chunks
        const incomingFiles = {}; 
        const completedBlobs = {}; 

        const statusEl = document.getElementById('status');
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileList = document.getElementById('file-list');
        const controlsDiv = document.getElementById('controls');
        
        // --- 1. Connection Logic ---
        peer.on('open', (id) => {
            const urlParams = new URLSearchParams(window.location.search);
            const hostId = urlParams.get('host');

            if (hostId) {
                // Receiver (Phone)
                statusEl.textContent = "Connecting to host...";
                conn = peer.connect(hostId);
                setupReceiver();
                document.getElementById('qrcode').style.display = 'none';
                dropZone.style.display = 'none'; 
                controlsDiv.style.display = 'flex';
            } else {
                // Sender (PC)
                statusEl.textContent = "Waiting for connection...";
                const joinUrl = `${window.location.href.split('?')[0]}?host=${id}`;
                new QRCode(document.getElementById("qrcode"), joinUrl);
                document.getElementById('join-link').href = joinUrl;
                document.getElementById('join-link').textContent = joinUrl;
                document.getElementById('link-container').style.display = 'block';

                peer.on('connection', (c) => {
                    conn = c;
                    statusEl.textContent = "Device Connected!";
                    setupSender();
                    document.getElementById('qrcode').style.display = 'none';
                    document.getElementById('link-container').style.display = 'none';
                });
            }
        });

        // --- 2. Sender Logic (PC) ---
        function setupSender() {
            conn.on('open', () => {
                statusEl.textContent = "Ready to Send";
                dropZone.style.borderColor = "#28a745";
            });
            
            conn.on('data', (data) => {
                if(data.type === 'download-confirm') markAsDownloadedUI(data.name);
            });

            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('highlight'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('highlight'));
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault(); dropZone.classList.remove('highlight');
                handleFiles(e.dataTransfer.files);
            });
            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => handleFiles(fileInput.files));
        }

        // UPDATED: Triggers all files at once (Parallel)
        function handleFiles(files) {
            if (!conn || !conn.open) return alert("Connect a device first!");
            
            // Loop through all files and start 'sendFile' immediately for each
            Array.from(files).forEach(file => {
                sendFile(file);
            });
        }

        // New function to handle individual file logic
        async function sendFile(file) {
            const fileId = Math.random().toString(36).substr(2, 9);
            createFileItemUI(fileId, file.name, "Sending...", false); 
            
            // 1. Send Start Header
            conn.send({ 
                type: 'start', id: fileId, name: file.name, 
                size: file.size, fileType: file.type 
            });

            // 2. Chunk and Send
            const chunkSize = 16 * 1024; // 16KB chunks
            let offset = 0;
            
            while(offset < file.size) {
                const chunk = file.slice(offset, offset + chunkSize);
                const buffer = await chunk.arrayBuffer();
                
                conn.send({ 
                    type: 'chunk', id: fileId, 
                    data: buffer 
                });
                
                offset += buffer.byteLength;
                updateProgressUI(fileId, offset, file.size);
                
                // Keep the small delay to prevent UI freezing, 
                // but since we aren't awaiting the whole file, others will run too.
                if (offset % (chunkSize * 10) === 0) await new Promise(r => setTimeout(r, 5));
            }
            
            // 3. Update UI to Sent
            document.getElementById(`status-${fileId}`).textContent = "Sent ✅";
        }

        // --- 3. Receiver Logic (Phone) ---
        function setupReceiver() {
            conn.on('open', () => statusEl.textContent = "Ready to Receive");
            
            conn.on('data', (data) => {
                if (data.type === 'start') {
                    // Initialize file buffer
                    incomingFiles[data.id] = {
                        chunks: [], total: data.size, received: 0,
                        name: data.name, type: data.fileType
                    };
                    createFileItemUI(data.id, data.name, "Receiving...", true);
                } 
                else if (data.type === 'chunk') {
                    const f = incomingFiles[data.id];
                    if (!f) return;

                    f.chunks.push(data.data);
                    f.received += data.data.byteLength;
                    
                    updateProgressUI(data.id, f.received, f.total);

                    if (f.received >= f.total) {
                        // Complete! Reassemble
                        const blob = new Blob(f.chunks, { type: f.type });
                        completedBlobs[f.name] = blob;
                        
                        finalizeReceiverItem(data.id, f.name);
                        delete incomingFiles[data.id]; 
                    }
                }
            });
        }

        // --- 4. UI Functions ---

        function createFileItemUI(id, name, statusText, isReceiver) {
            const li = document.createElement('li');
            li.className = 'file-item';
            li.id = `item-${id}`;
            li.dataset.filename = name; 

            let controlsHtml = '';
            if(isReceiver) {
                controlsHtml = `
                    <div class="download-ui" id="dl-ui-${id}">
                        <input type="checkbox" class="file-check" value="${name}">
                        <button onclick="triggerDownload('${name}')">↓ Download</button>
                    </div>
                `;
            }

            li.innerHTML = `
                <div class="file-header">
                    <span class="file-name">${name}</span>
                    <span class="file-meta" id="status-${id}">${statusText}</span>
                </div>
                <div class="progress-bar-container" id="prog-cont-${id}">
                    <div class="progress-bar-fill" id="prog-bar-${id}"></div>
                </div>
                ${controlsHtml}
            `;
            fileList.appendChild(li);
        }

        function updateProgressUI(id, current, total) {
            const percent = Math.round((current / total) * 100);
            const bar = document.getElementById(`prog-bar-${id}`);
            const status = document.getElementById(`status-${id}`);
            if (bar) bar.style.width = `${percent}%`;
            if (status) status.textContent = `${percent}%`;
        }

        function finalizeReceiverItem(id, name) {
            document.getElementById(`prog-cont-${id}`).style.display = 'none';
            document.getElementById(`status-${id}`).textContent = 'Ready';
            document.getElementById(`dl-ui-${id}`).style.display = 'flex';
        }

        function markAsDownloadedUI(name) {
            const items = document.querySelectorAll('.file-item');
            items.forEach(li => {
                if(li.dataset.filename === name) {
                    li.classList.add('downloaded');
                    const btn = li.querySelector('button');
                    if(btn) btn.textContent = "✓";
                    const status = li.querySelector('.file-meta');
                    if(status) status.textContent = "Downloaded";
                    const cb = li.querySelector('input[type="checkbox"]');
                    if(cb) { cb.checked = false; cb.disabled = true; }
                }
            });
        }

        // --- 5. Download & Sync ---

        function triggerDownload(name) {
            const blob = completedBlobs[name];
            if (!blob) return;

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            markAsDownloadedUI(name);

            if(conn && conn.open) {
                conn.send({ type: 'download-confirm', name: name });
            }
        }

        document.getElementById('select-all').addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.file-check:not(:disabled)');
            checkboxes.forEach(cb => cb.checked = e.target.checked);
        });

        document.getElementById('download-all-btn').addEventListener('click', () => {
            const checkedBoxes = document.querySelectorAll('.file-check:checked');
            if (checkedBoxes.length === 0) return alert("Select files first!");

            let delay = 0;
            checkedBoxes.forEach(cb => {
                setTimeout(() => triggerDownload(cb.value), delay);
                delay += 500;
            });
            document.getElementById('select-all').checked = false;
        });
    </script>
</body>
</html>
