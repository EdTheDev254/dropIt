<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Transfer + QR</title>
    <!-- Basic QR Library (Required for the QR stuff) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: monospace; background: #1a1a1a; color: #0f0; padding: 20px; }
        
        /* THE DRAG & DROP ZONE */
        #drop-zone {
            border: 2px dashed #0f0;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            background: #222;
            cursor: pointer;
        }
        #drop-zone.hover { background: #333; }

        /* FILE LIST ITEM */
        .file-item {
            border: 1px solid #444;
            padding: 10px;
            margin-bottom: 10px;
            background: #222;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        .file-info { flex: 1; min-width: 200px; }
        .qr-container { margin-left: 15px; background: white; padding: 5px; display: none; }

        /* PROGRESS BARS */
        .progress-wrapper { width: 100%; margin-top: 5px; }
        progress { width: 100%; height: 20px; }
        
        .status { color: #aaa; font-size: 12px; margin-left: 10px; }
        a.download-link { color: #0ff; text-decoration: none; font-weight: bold; display: none; }
    </style>
</head>
<body>

    <!-- 1. DRAG AND DROP AREA -->
    <div id="drop-zone">
        Drag files here or click to select
        <input type="file" id="fileInput" multiple style="display:none">
    </div>

    <!-- 2. FILE LIST AREA -->
    <div id="file-list"></div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('fileInput');
        const list = document.getElementById('file-list');

        // --- DRAG & DROP EVENTS ---
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('hover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('hover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('hover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // --- MAIN LOGIC ---
        function handleFiles(files) {
            Array.from(files).forEach(file => {
                uploadAndProcess(file);
            });
        }

        function uploadAndProcess(file) {
            // 1. Create UI Elements
            const item = document.createElement('div');
            item.className = 'file-item';
            
            // HTML Structure for the row
            item.innerHTML = `
                <div class="file-info">
                    <strong>${file.name}</strong> <span class="status">Waiting...</span>
                    <div class="progress-wrapper">
                        <progress value="0" max="100"></progress>
                    </div>
                    <a href="#" class="download-link">Ready for Download</a>
                </div>
                <div class="qr-container"></div>
            `;
            list.appendChild(item);

            const progressBar = item.querySelector('progress');
            const statusText = item.querySelector('.status');
            const qrBox = item.querySelector('.qr-container');
            const downloadLink = item.querySelector('.download-link');

            // 2. SETUP UPLOAD (SENDING)
            const xhr = new XMLHttpRequest();
            const formData = new FormData();
            formData.append('file', file);

            // TRACK SENDING PROGRESS
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    progressBar.value = percent;
                    statusText.innerText = `Sending: ${Math.round(percent)}%`;
                }
            };

            xhr.onload = () => {
                if (xhr.status === 200) {
                    // 3. UPLOAD COMPLETE -> SHOW QR
                    const downloadUrl = xhr.responseText; // Assume server echoes URL
                    statusText.innerText = "Sent. Generating QR...";
                    
                    // Generate QR
                    qrBox.style.display = 'block';
                    new QRCode(qrBox, {
                        text: downloadUrl,
                        width: 64,
                        height: 64
                    });

                    // 4. IMMEDIATELY START "LOADING" (PRE-FETCH)
                    // This fetches the file blob so it's instant when clicked
                    startPreLoad(downloadUrl, progressBar, statusText, downloadLink, file.name);

                } else {
                    statusText.innerText = "Upload Failed.";
                }
            };

            xhr.open('POST', 'your_upload_script.php', true);
            xhr.send(formData);
        }

        // --- THE "LOADING" LOGIC (Fetch before Download) ---
        function startPreLoad(url, progressBar, statusText, linkBtn, filename) {
            const xhrLoad = new XMLHttpRequest();
            xhrLoad.open('GET', url, true);
            xhrLoad.responseType = 'blob'; // Important for binary files

            // TRACK LOADING PROGRESS
            xhrLoad.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    progressBar.value = percent;
                    statusText.innerText = `Loading into Memory: ${Math.round(percent)}%`;
                }
            };

            xhrLoad.onload = function() {
                if (this.status === 200) {
                    // 5. READY FOR DOWNLOAD
                    const blob = this.response;
                    const objectUrl = window.URL.createObjectURL(blob);
                    
                    progressBar.value = 100;
                    statusText.innerText = "Ready.";
                    
                    linkBtn.href = objectUrl;
                    linkBtn.download = filename;
                    linkBtn.style.display = 'block'; // Show the button now
                }
            };

            xhrLoad.send();
        }
    </script>
</body>
</html>
